name: AKS Deployment

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v3

      # Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login to ACR
      - name: Login to ACR
        run: |
          az acr login --name wealthwiseregistry

      # Set AKS context
      - name: Set AKS context
        run: |
          az aks get-credentials --resource-group devopsca2 --name wealthwise-cluster

      # Generate image tag based on commit SHA
      - name: Set image tag
        id: vars
        run: echo "IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build -t wealthwiseregistry.azurecr.io/wealthwise-backend:${{ env.IMAGE_TAG }} ./WealthWise-Group12-CA2-PRN-086-119-120-135/backend

      # Push Docker image to ACR
      - name: Push Docker image
        run: |
          docker push wealthwiseregistry.azurecr.io/wealthwise-backend:${{ env.IMAGE_TAG }}

      # Update deployment with new image
      - name: Deploy to AKS
        run: |
          kubectl set image deployment/wealthwise-backend wealthwise-backend=wealthwiseregistry.azurecr.io/wealthwise-backend:${{ env.IMAGE_TAG }}
          kubectl rollout status deployment/wealthwise-backend
